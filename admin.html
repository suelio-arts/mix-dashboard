<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIX Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            -webkit-font-smoothing: antialiased;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-box h1 {
            font-size: 28px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .login-box .subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 12px 24px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-signin-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .google-signin-btn:active {
            transform: scale(0.98);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            display: none;
        }

        .loading {
            color: #6b7280;
            font-size: 14px;
            margin-top: 16px;
        }

        /* Admin Interface */
        #admin-interface {
            display: none;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .user-name {
            font-size: 14px;
            color: #374151;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #e5e7eb;
        }

        .tabs {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            display: flex;
            gap: 8px;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #111827;
            border-bottom-color: #111827;
        }

        .tab-content {
            display: none;
            padding: 24px;
        }

        .tab-content.active {
            display: block;
        }

        .placeholder-section {
            background: white;
            padding: 48px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .placeholder-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .placeholder-section p {
            color: #6b7280;
            font-size: 14px;
        }

        #analytics-content,
        #narrative-history-content {
            width: 100%;
            height: calc(100vh - 120px);
            border: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <h1>üé≠ MIX Admin</h1>
            <p class="subtitle">Sign in to access the admin dashboard</p>

            <button id="google-signin" class="google-signin-btn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>

            <div id="login-error" class="error-message"></div>
            <div id="login-loading" class="loading" style="display: none;">Checking access...</div>
        </div>
    </div>

    <!-- Admin Interface -->
    <div id="admin-interface">
        <header class="header">
            <div class="header-left">
                <h1>üé≠ MIX Admin Dashboard</h1>
            </div>
            <div class="user-info">
                <img id="user-avatar" class="user-avatar" src="" alt="">
                <span id="user-name" class="user-name"></span>
                <button id="logout-btn" class="logout-btn">Sign Out</button>
            </div>
        </header>

        <nav class="tabs">
            <button class="tab active" data-tab="analytics">üìä Analytics</button>
            <button class="tab" data-tab="tours">üó∫Ô∏è Tours</button>
            <button class="tab" data-tab="content">üìö Narrative History</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
        </nav>

        <div id="analytics-tab" class="tab-content active">
            <iframe id="analytics-content" src="dashboard.html"></iframe>
        </div>

        <div id="tours-tab" class="tab-content">
            <div class="placeholder-section">
                <h2>üó∫Ô∏è Tour Analytics</h2>
                <p>Tour completion rates and engagement metrics will appear here.</p>
                <p style="margin-top: 8px; font-size: 13px; color: #9ca3af;">Requires tour-visit-tracking PRD implementation.</p>
            </div>
        </div>

        <div id="content-tab" class="tab-content">
            <iframe id="narrative-history-content" src="narrative-history.html"></iframe>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="placeholder-section">
                <h2>‚öôÔ∏è Settings</h2>
                <p>Admin user management and system configuration will appear here.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration (matches existing dashboard config)
        const firebaseConfig = {
            apiKey: "AIzaSyDOAuOCT4_N2-erb_lWPYYdv1buhYvMXcg",
            authDomain: "suelio-ar.firebaseapp.com",
            projectId: "suelio-ar",
            storageBucket: "suelio-ar.firebasestorage.app",
            messagingSenderId: "807518951165",
            appId: "1:807518951165:web:18da6bc6729a0bddc69999"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // UI Elements
        const loginContainer = document.getElementById('login-container');
        const adminInterface = document.getElementById('admin-interface');
        const googleSigninBtn = document.getElementById('google-signin');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const loginLoading = document.getElementById('login-loading');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');

        // Check if user is admin
        async function isAdminUser(email) {
            try {
                // Check admin_users collection
                const adminDoc = await getDoc(doc(db, 'admin_users', email));
                return adminDoc.exists() && adminDoc.data().isAdmin === true;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return false;
            }
        }

        // Show error message
        function showError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
            loginLoading.style.display = 'none';
        }

        // Show admin interface
        function showAdminInterface(user) {
            loginContainer.style.display = 'none';
            adminInterface.style.display = 'block';
            userAvatar.src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23e5e7eb"/></svg>';
            userName.textContent = user.displayName || user.email;
        }

        // Show login screen
        function showLoginScreen() {
            loginContainer.style.display = 'flex';
            adminInterface.style.display = 'none';
        }

        // Google Sign-In
        googleSigninBtn.addEventListener('click', async () => {
            try {
                loginError.style.display = 'none';
                loginLoading.style.display = 'block';
                loginLoading.textContent = 'Signing in...';

                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                loginLoading.textContent = 'Checking access...';

                // Check if user is admin
                const isAdmin = await isAdminUser(user.email);

                if (!isAdmin) {
                    await signOut(auth);
                    showError(`Access denied. "${user.email}" is not authorized as an admin.`);
                    return;
                }

                // User is admin, show interface
                showAdminInterface(user);

            } catch (error) {
                console.error('Sign-in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showError('Sign-in cancelled. Please try again.');
                } else {
                    showError('Sign-in failed: ' + error.message);
                }
            }
        });

        // Sign Out
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showLoginScreen();
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        });

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in, check if admin
                loginLoading.style.display = 'block';
                loginLoading.textContent = 'Checking access...';

                const isAdmin = await isAdminUser(user.email);

                if (isAdmin) {
                    showAdminInterface(user);
                } else {
                    await signOut(auth);
                    showError(`Access denied. "${user.email}" is not authorized as an admin.`);
                }
            } else {
                // User is signed out
                showLoginScreen();
            }
        });

        // Tab Navigation
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active content
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
    </script>
</body>
</html>
