<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elements - MIX Data Browser</title>
  <link rel="stylesheet" href="../css/browser-common.css">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <style>
    /* Override for elements page */
    .container {
      max-width: 100%;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <a href="../index.html" class="back-link">‚Üê Back to Browser</a>
        <h1>üìç Elements</h1>
        <p class="subtitle">AR elements with map visualization</p>
      </div>
      <div class="header-actions">
        <button class="dark-mode-toggle" id="dark-mode-toggle">
          <span id="dark-mode-icon">üåô</span>
          <span id="dark-mode-label">Dark</span>
        </button>
      </div>
    </header>

    <div class="elements-layout">
      <div class="map-container">
        <div id="map"></div>
      </div>

      <div class="sidebar-container">
        <div class="detail-sidebar">
          <div id="sidebar-content" class="sidebar-empty">
            <p>Select an element from the map or table to view details</p>
          </div>
        </div>
      </div>

      <div class="table-section">
        <div class="table-container">
          <div id="table-container">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading elements...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <script type="module">
    import {
      fetchCollection,
      resolveReference,
      resolveReferences,
      formatDate,
      formatGeoPoint,
      escapeHtml
    } from '../js/firestore-browser.js';
    import { renderTable, sortData, showError } from '../js/table-utils.js';
    import {
      initializeMap,
      updateMapTiles,
      addElementMarkers,
      updateMarkerSelection,
      fitBoundsToMarkers,
      panToMarker
    } from '../js/map-utils.js';

    // Column configuration
    const columns = [
      { key: 'name', label: 'Name', type: 'text' },
      { key: 'description', label: 'Description', type: 'text', truncate: 60 },
      { key: 'location', label: 'Location', type: 'geopoint' },
      { key: 'visibility', label: 'Visibility', type: 'badge' },
      { key: 'layer', label: 'Layer', type: 'reference' },
      { key: 'placements', label: 'Placements', type: 'references' },
      { key: 'created', label: 'Created', type: 'date' }
    ];

    let elementsData = [];
    let map = null;
    let markers = [];
    let selectedElement = null;
    let selectedMarker = null;

    async function loadElements() {
      try {
        elementsData = await fetchCollection('elements', {
          orderByField: 'created',
          orderDirection: 'desc',
          maxResults: 200
        });

        // Initialize map
        map = initializeMap('map', {
          center: [42.3601, -71.0589], // Boston
          zoom: 12
        });

        // Add markers
        markers = addElementMarkers(map, elementsData, handleMarkerClick);

        // Fit bounds to show all markers
        if (markers.length > 0) {
          fitBoundsToMarkers(map, markers);
        }

        // Render table
        renderTable('table-container', elementsData, columns, {
          onRowClick: handleRowClick,
          onSort: handleSort
        });
      } catch (error) {
        showError('table-container', 'Failed to load elements: ' + error.message);
      }
    }

    function handleSort(key, direction) {
      const sorted = sortData(elementsData, key, direction);
      renderTable('table-container', sorted, columns, {
        onRowClick: handleRowClick,
        onSort: handleSort
      });
    }

    function handleMarkerClick(element, marker) {
      selectElement(element, marker);
    }

    function handleRowClick(element) {
      // Find the corresponding marker
      const marker = markers.find(m => m._elementData?.id === element.id);
      selectElement(element, marker);

      // Pan to marker if found
      if (marker) {
        panToMarker(map, marker, 15);
      }
    }

    function selectElement(element, marker) {
      selectedElement = element;
      selectedMarker = marker;

      // Update marker selection
      updateMarkerSelection(markers, marker);

      // Update table row selection
      document.querySelectorAll('#table-container tbody tr').forEach(tr => {
        tr.classList.remove('selected');
        if (tr.dataset.id === element.id) {
          tr.classList.add('selected');
        }
      });

      // Update sidebar
      renderSidebar(element);
    }

    async function renderSidebar(element) {
      const container = document.getElementById('sidebar-content');

      // Show loading state
      container.innerHTML = `
        <div class="sidebar-header">
          <h2>${escapeHtml(element.name || 'Unnamed Element')}</h2>
          <span class="badge ${element.visibility === 'draft' ? 'badge-warning' : 'badge-success'}">${escapeHtml(element.visibility || 'unknown')}</span>
        </div>
        <div class="sidebar-content">
          <div class="loading"><div class="spinner"></div><p>Loading details...</p></div>
        </div>
      `;

      // Resolve references
      let layerData = null;
      let creatorsData = [];

      try {
        if (element.layer && element.layer._ref) {
          layerData = await resolveReference(element.layer);
        }

        if (element.creators && element.creators.length > 0) {
          creatorsData = await resolveReferences(element.creators);
        }
      } catch (error) {
        console.error('Error resolving references:', error);
      }

      // Render full sidebar
      container.innerHTML = `
        <div class="sidebar-header">
          <h2>${escapeHtml(element.name || 'Unnamed Element')}</h2>
          <span class="badge ${element.visibility === 'draft' ? 'badge-warning' : 'badge-success'}">${escapeHtml(element.visibility || 'unknown')}</span>
        </div>
        <div class="sidebar-content">
          ${element.description ? `
            <div class="sidebar-field">
              <div class="sidebar-label">Description</div>
              <div class="sidebar-value">${escapeHtml(element.description)}</div>
            </div>
          ` : ''}

          <div class="sidebar-field">
            <div class="sidebar-label">Location</div>
            <div class="sidebar-value">${escapeHtml(formatGeoPoint(element.location))}</div>
          </div>

          <div class="sidebar-field">
            <div class="sidebar-label">Layer</div>
            <div class="sidebar-value">${layerData ? escapeHtml(layerData.name) : '<span class="text-muted">Not linked</span>'}</div>
          </div>

          <div class="sidebar-field">
            <div class="sidebar-label">Creators</div>
            <div class="sidebar-value">
              ${creatorsData.length > 0
                ? creatorsData.map(c => escapeHtml(c.name)).join(', ')
                : '<span class="text-muted">No creators</span>'
              }
            </div>
          </div>

          <div class="sidebar-field">
            <div class="sidebar-label">Placements</div>
            <div class="sidebar-value">${element.placements?.length || 0} placement(s)</div>
          </div>

          ${element.created ? `
            <div class="sidebar-field">
              <div class="sidebar-label">Created</div>
              <div class="sidebar-value">${escapeHtml(formatDate(element.created))}</div>
            </div>
          ` : ''}

          <div class="sidebar-field">
            <div class="sidebar-label">Document ID</div>
            <div class="sidebar-value"><code style="font-size: 12px; word-break: break-all;">${escapeHtml(element.id)}</code></div>
          </div>
        </div>
      `;
    }

    // Dark mode toggle
    const toggle = document.getElementById('dark-mode-toggle');
    const icon = document.getElementById('dark-mode-icon');
    const label = document.getElementById('dark-mode-label');

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      icon.textContent = '‚òÄÔ∏è';
      label.textContent = 'Light';
    }

    toggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      label.textContent = isDark ? 'Light' : 'Dark';

      // Update map tiles
      if (map) {
        updateMapTiles(map);
      }
    });

    // Load data
    loadElements();
  </script>
</body>
</html>
